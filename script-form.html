<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Script Generator | Content Creator Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google OAuth2 API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- html2canvas for converting HTML to canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- EmailJS for sending emails directly from the browser -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); }
        .level-badge { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .level-beginner { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .level-explorer { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .level-power { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /* 
         * 🚨 DEVELOPMENT NOTICES (Safe to ignore):
         * - React DevTools: Optional browser extension for debugging
         * - Tailwind CDN: For production, use PostCSS plugin instead
         * - Babel In-Browser: For production, precompile scripts
         * These warnings don't affect functionality in development
         */
        
        /* 
         * 📧 EMAIL SETUP INSTRUCTIONS:
         * 1. Go to https://www.emailjs.com/ and create a free account
         * 2. Create an email service (Gmail, Outlook, etc.)
         * 3. Create an email template with these variables:
         *    - {{to_email}} - recipient email
         *    - {{to_name}} - recipient name
         *    - {{from_name}} - sender name
         *    - {{subject}} - email subject
         *    - {{topic}} - script topic
         *    - {{audience}} - target audience
         *    - {{tone}} - script tone
         *    - {{length}} - script length
         *    - {{script_content}} - the actual script
         *    - {{generated_date}} - generation date
         *    - {{generated_time}} - generation time
         * 4. Update the EmailJS configuration below with your IDs
         * 5. If EmailJS is not configured, the fallback "Open in Email App" button will work
         */
        
        // 🔧 Google OAuth2 Configuration
        const GOOGLE_CLIENT_ID = "1008087310880-fsfesk9f2nugahb248nki1qddbhsamkd.apps.googleusercontent.com"; // Replace with your OAuth client ID
        
        // 📧 EmailJS Configuration - REPLACE THESE WITH YOUR ACTUAL VALUES
        const EMAILJS_SERVICE_ID = "service_wep8wbw"; // Replace with your Service ID from Step 2
        const EMAILJS_TEMPLATE_ID = "template_ax5ib3w"; // Replace with your Template ID from Step 3
        const EMAILJS_PUBLIC_KEY = "_zGfUbS6rgPyp4WC0"; // Replace with your Public Key from Step 4
        
        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }
        
        // OAuth Authentication System
        class GoogleOAuth {
            constructor() {
                this.currentUser = null;
                this.listeners = [];
                this.initialized = false;
                this.initializeGoogleAuth();
            }

            async initializeGoogleAuth() {
                try {
                    // Wait for Google API to load
                    while (!window.google) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    await new Promise((resolve) => {
                        google.accounts.id.initialize({
                            client_id: GOOGLE_CLIENT_ID,
                            callback: this.handleCredentialResponse.bind(this),
                            auto_select: false,
                            cancel_on_tap_outside: false
                        });
                        resolve();
                    });
                    
                    this.initialized = true;
                    console.log("✅ Google OAuth initialized successfully!");
                    
                    // Check for existing session
                    const storedUser = localStorage.getItem('oauthUser');
                    if (storedUser) {
                        this.currentUser = JSON.parse(storedUser);
                        this.notifyListeners(this.currentUser);
                    } else {
                        this.notifyListeners(null);
                    }
                } catch (error) {
                    console.error("OAuth initialization error:", error);
                    this.initialized = true;
                    this.notifyListeners(null);
                }
            }

            handleCredentialResponse(response) {
                try {
                    // Decode JWT token
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    
                    const user = {
                        uid: payload.sub,
                        email: payload.email,
                        displayName: payload.name,
                        photoURL: payload.picture,
                        emailVerified: payload.email_verified
                    };
                    
                    this.currentUser = user;
                    localStorage.setItem('oauthUser', JSON.stringify(user));
                    this.notifyListeners(user);
                    
                    console.log('OAuth sign in successful:', user);
                } catch (error) {
                    console.error('OAuth credential parsing error:', error);
                    this.notifyListeners(null);
                }
            }

            onAuthStateChanged(callback) {
                this.listeners.push(callback);
                
                // If already initialized, call immediately
                if (this.initialized) {
                    callback(this.currentUser);
                }
                
                // Return unsubscribe function
                return () => {
                    this.listeners = this.listeners.filter(listener => listener !== callback);
                };
            }

            notifyListeners(user) {
                this.listeners.forEach(listener => listener(user));
            }

            async signInWithPopup() {
                return new Promise((resolve, reject) => {
                    if (!this.initialized) {
                        reject(new Error('OAuth not initialized'));
                        return;
                    }

                    try {
                        // Store resolve function to call after sign in
                        this.signInResolve = resolve;
                        this.signInReject = reject;
                        
                        // Trigger Google sign in popup
                        google.accounts.id.prompt((notification) => {
                            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                                // Fallback to manual trigger
                                const tempListener = (user) => {
                                    if (user) {
                                        resolve({ user });
                                        this.listeners = this.listeners.filter(l => l !== tempListener);
                                    }
                                };
                                this.listeners.push(tempListener);
                                
                                // Show one-click sign in
                                google.accounts.id.renderButton(
                                    document.getElementById('temp-google-signin'),
                                    {
                                        theme: 'outline',
                                        size: 'large',
                                        width: '300'
                                    }
                                );
                                
                                // Auto-click the button
                                setTimeout(() => {
                                    const btn = document.querySelector('#temp-google-signin div[role="button"]');
                                    if (btn) btn.click();
                                }, 100);
                            }
                        });
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            async signOut() {
                try {
                    this.currentUser = null;
                    localStorage.removeItem('oauthUser');
                    this.notifyListeners(null);
                    
                    // Clear Google session
                    if (window.google?.accounts?.id) {
                        google.accounts.id.disableAutoSelect();
                    }
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            }
        }

        // Initialize OAuth
        const auth = new GoogleOAuth();
        const provider = {}; // Compatibility with existing code

        // Level System
        const getLevelInfo = (scriptCount) => {
            if (scriptCount <= 5) return { level: "🎯 Beginner", color: "level-beginner", progress: (scriptCount / 5) * 100 };
            if (scriptCount <= 15) return { level: "🏆 Explorer", color: "level-explorer", progress: ((scriptCount - 5) / 10) * 100 };
            return { level: "🔥 Power User", color: "level-power", progress: 100 };
        };

        // Main App Component
        function App() {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [authLoading, setAuthLoading] = React.useState(true);
            const [scriptGenerated, setScriptGenerated] = React.useState(false);
            const [generatedScript, setGeneratedScript] = React.useState("");
            const [editableScript, setEditableScript] = React.useState("");
            const [scriptSent, setScriptSent] = React.useState(false);
            const [feedback, setFeedback] = React.useState({ rating: null, comment: "" });
            const [scriptCount, setScriptCount] = React.useState(0);
            const [showFeedback, setShowFeedback] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('edit'); // 'edit' or 'preview'

            const [formData, setFormData] = React.useState({
                topic: "",
                audience: "",
                tone: "",
                length: "medium",
                email: ""
            });

            // Initialize user data and script count
            React.useEffect(() => {
                setAuthLoading(true);
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setUser(user);
                        const count = localStorage.getItem(`scriptCount_${user.uid}`) || 0;
                        setScriptCount(parseInt(count));
                        setError(null);
                    } else {
                        setUser(null);
                        setScriptCount(0);
                    }
                    setAuthLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // Google Sign In
            const signInWithGoogle = async () => {
                try {
                    setError(null);
                    setLoading(true);
                    const result = await auth.signInWithPopup(provider);
                    console.log('Sign in successful:', result.user);
                } catch (error) {
                    console.error("Sign in error:", error);
                    setError(getFirebaseErrorMessage(error));
                } finally {
                    setLoading(false);
                }
            };

            // Sign Out
            const signOut = async () => {
                try {
                    await auth.signOut();
                    setUser(null);
                    setScriptGenerated(false);
                    setScriptSent(false);
                    setShowFeedback(false);
                    setError(null);
                } catch (error) {
                    console.error("Sign out error:", error);
                    setError("Failed to sign out. Please try again.");
                }
            };

            // Helper function to get user-friendly error messages
            const getFirebaseErrorMessage = (error) => {
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        return 'Sign-in popup was closed. Please try again.';
                    case 'auth/popup-blocked':
                        return 'Popup was blocked by browser. Please allow popups and try again.';
                    case 'auth/cancelled-popup-request':
                        return 'Sign-in was cancelled. Please try again.';
                    case 'auth/network-request-failed':
                        return 'Network error. Please check your connection and try again.';
                    case 'auth/too-many-requests':
                        return 'Too many attempts. Please wait a moment and try again.';
                    default:
                        return error.message || 'An error occurred during sign-in. Please try again.';
                }
            };

            // Handle form submission
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;

                setLoading(true);
                setError(null);

                try {
                    console.log('🚀 Calling n8n webhook for AI script generation...');
                    
                    const requestPayload = {
                        email: user.email,
                        name: user.displayName,
                        uid: user.uid,
                        action: "generate_script",
                        topic: formData.topic,
                        userEmail: formData.email,
                        audience: formData.audience,
                        tone: formData.tone,
                        length: formData.length,
                        timestamp: new Date().toISOString()
                    };

                    console.log('📤 Request payload:', requestPayload);

                    // API call to n8n webhook
                    const response = await fetch("https://datu.app.n8n.cloud/webhook-test/89d917f1-57fc-4581-b3bb-21e54c1c6d8a", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify(requestPayload)
                    });

                    console.log('📡 Response status:', response.status);
                    console.log('📡 Response headers:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('📨 Response data from n8n:', data);

                    // Extract the actual AI-generated script from n8n response
                    let scriptContent = null;

                    // Try different possible response structures from n8n
                    if (data.script) {
                        scriptContent = data.script;
                        console.log('✅ Found script in data.script (n8n webhook format)');
                        console.log('📝 Script preview:', scriptContent.substring(0, 100) + '...');
                    } else if (data.generated_script) {
                        scriptContent = data.generated_script;
                        console.log('✅ Found script in data.generated_script');
                    } else if (data.content) {
                        scriptContent = data.content;
                        console.log('✅ Found script in data.content');
                    } else if (data.result) {
                        scriptContent = data.result;
                        console.log('✅ Found script in data.result');
                    } else if (data.message) {
                        scriptContent = data.message;
                        console.log('✅ Found script in data.message');
                    } else if (typeof data === 'string') {
                        scriptContent = data;
                        console.log('✅ Response is a string, using as script');
                    } else {
                        console.log('⚠️ Could not find script in response, checking nested objects...');
                        
                        // Check for nested objects
                        const dataKeys = Object.keys(data);
                        console.log('Available keys in response:', dataKeys);
                        
                        // Try to find script content in nested objects
                        for (const key of dataKeys) {
                            if (data[key] && typeof data[key] === 'object') {
                                if (data[key].script || data[key].content || data[key].result) {
                                    scriptContent = data[key].script || data[key].content || data[key].result;
                                    console.log(`✅ Found script in data.${key}.script/content/result`);
                                    break;
                                }
                            }
                        }
                    }

                    // If still no script found, use the entire response as fallback
                    if (!scriptContent) {
                        console.log('⚠️ No script found, using entire response');
                        scriptContent = JSON.stringify(data, null, 2);
                    }

                    // If scriptContent is still empty or invalid, use a helpful fallback
                    if (!scriptContent || scriptContent.trim().length === 0) {
                        console.log('❌ Script content is empty, using fallback template');
                        scriptContent = `# ${formData.topic}

## 🤖 AI Script Generator Response

**Note**: The n8n webhook responded but didn't return script content in the expected format.

**Response received**: ${JSON.stringify(data, null, 2)}

---

## � Template Script for: ${formData.topic}

### Introduction
Welcome to this video about **${formData.topic}**! This content is designed for **${formData.audience}** with a **${formData.tone}** tone.

### Main Content
[Your AI-generated content would appear here based on the n8n workflow]

### Conclusion
Thank you for watching!

---
*Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}*

**Debug Info**: Please check your n8n workflow to ensure it returns the script content in one of these formats:
- { "script": "your content" }
- { "content": "your content" }  
- { "result": "your content" }
- { "message": "your content" }`;
                    }

                    console.log('📝 Final script content length:', scriptContent.length);
                    
                    // Clean up script content - remove any extra quotes or JSON artifacts
                    if (typeof scriptContent === 'string') {
                        // Remove potential escaped quotes and clean up formatting
                        scriptContent = scriptContent
                            .replace(/^["']|["']$/g, '') // Remove leading/trailing quotes
                            .replace(/\\n/g, '\n')       // Convert escaped newlines to actual newlines
                            .replace(/\\t/g, '\t')       // Convert escaped tabs to actual tabs
                            .replace(/\\"/g, '"')        // Convert escaped quotes to actual quotes
                            .trim();                     // Remove extra whitespace
                        
                        console.log('🧹 Cleaned script content preview:', scriptContent.substring(0, 200) + '...');
                    }
                    
                    setGeneratedScript(scriptContent);
                    setEditableScript(scriptContent);
                    setScriptGenerated(true);

                } catch (error) {
                    console.error("❌ Error generating script:", error);
                    setError("Failed to generate script from n8n webhook. Please check your connection and n8n workflow configuration.");
                } finally {
                    setLoading(false);
                }
            };

            // Send final script via email (using EmailJS)
            const sendScript = async () => {
                // Validate email field
                if (!formData.email || !formData.email.trim()) {
                    setError("Please enter an email address in the form before sending the script.");
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(formData.email)) {
                    setError("Please enter a valid email address.");
                    return;
                }

                setLoading(true);
                setError(null);
                
                try {
                    console.log('📧 Attempting to send script via EmailJS...');
                    console.log('Target email:', formData.email);
                    console.log('Script length:', editableScript.length, 'characters');

                    // Check if EmailJS is available
                    if (typeof emailjs === 'undefined') {
                        throw new Error('EmailJS library not loaded. Please check your internet connection.');
                    }

                    // Prepare email template parameters
                    const templateParams = {
                        to_email: formData.email,
                        to_name: 'Content Creator',
                        from_name: user.displayName || 'AI Script Generator',
                        from_email: user.email,
                        subject: `Your AI Generated Script: ${formData.topic}`,
                        topic: formData.topic,
                        audience: formData.audience,
                        tone: formData.tone,
                        length: formData.length,
                        script_content: editableScript,
                        generated_date: new Date().toLocaleDateString(),
                        generated_time: new Date().toLocaleTimeString()
                    };

                    console.log('� Sending email with EmailJS...');

                    // Send email using EmailJS
                    const response = await emailjs.send(
                        EMAILJS_SERVICE_ID,
                        EMAILJS_TEMPLATE_ID,
                        templateParams
                    );

                    console.log('✅ Email sent successfully via EmailJS:', response);

                    // Show success message with email address
                    const successMessage = `Script sent successfully to ${formData.email}! Please check your inbox (and spam folder if needed).`;
                    
                    // Show success alert
                    alert(`📧 ${successMessage}`);

                    // Update script count
                    const newCount = scriptCount + 1;
                    setScriptCount(newCount);
                    localStorage.setItem(`scriptCount_${user.uid}`, newCount.toString());

                    setScriptSent(true);
                    setShowFeedback(true);

                } catch (error) {
                    console.error("❌ Error sending script via EmailJS:", error);
                    
                    // Provide more specific error messages
                    let errorMessage = "Failed to send script via email. ";
                    
                    if (error.text) {
                        // EmailJS specific error
                        errorMessage += `EmailJS Error: ${error.text}. `;
                        
                        if (error.text.includes('Invalid email')) {
                            errorMessage += "Please check the email address format.";
                        } else if (error.text.includes('Service ID')) {
                            errorMessage += "Email service configuration issue. Please try the download options below.";
                        } else if (error.text.includes('Template ID')) {
                            errorMessage += "Email template configuration issue. Please try the download options below.";
                        } else {
                            errorMessage += "Please try the download options below as an alternative.";
                        }
                    } else if (error.message) {
                        errorMessage += `${error.message}. Please try the download options below as an alternative.`;
                    } else {
                        errorMessage += "Unknown error occurred. Please try the download options below as an alternative.";
                    }
                    
                    setError(errorMessage);
                } finally {
                    setLoading(false);
                }
            };

            // Submit feedback
            const submitFeedback = async () => {
                if (feedback.rating === null) return;

                setLoading(true);
                setError(null);

                try {
                    const response = await fetch("https://datu.app.n8n.cloud/webhook-test/89d917f1-57fc-4581-b3bb-21e54c1c6d8a", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            email: user.email,
                            name: user.displayName,
                            uid: user.uid,
                            rating: feedback.rating,
                            comment: feedback.comment,
                            action: "feedback",
                            timestamp: new Date().toISOString()
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Reset for new script
                    setScriptGenerated(false);
                    setScriptSent(false);
                    setShowFeedback(false);
                    setFormData({ topic: "", email: "", audience: "", tone: "", length: "medium" });
                    setFeedback({ rating: null, comment: "" });

                } catch (error) {
                    console.error("Error submitting feedback:", error);
                    setError("Failed to submit feedback. Your feedback is important to us, please try again.");
                } finally {
                    setLoading(false);
                }
            };

            const levelInfo = getLevelInfo(scriptCount);

            // Download as PDF function
            const downloadAsPDF = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(20);
                    doc.text(`Video Script: ${formData.topic}`, 20, 20);
                    
                    // Add metadata
                    doc.setFontSize(12);
                    doc.text(`Target Audience: ${formData.audience}`, 20, 35);
                    doc.text(`Tone: ${formData.tone}`, 20, 45);
                    doc.text(`Length: ${formData.length}`, 20, 55);
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 65);
                    
                    // Add content
                    doc.setFontSize(10);
                    const splitText = doc.splitTextToSize(editableScript, 170);
                    doc.text(splitText, 20, 80);
                    
                    // Save the PDF
                    doc.save(`${formData.topic.replace(/[^a-zA-Z0-9]/g, '_')}_script.pdf`);
                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('❌ PDF generation failed. Please try copying the script instead.');
                }
            };

            // Download as DOC function (using RTF format which opens in Word)
            const downloadAsDOC = () => {
                try {
                    const rtfContent = `{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}
\\f0\\fs24 {\\b Video Script: ${formData.topic}}\\par
\\par
{\\b Target Audience:} ${formData.audience}\\par
{\\b Tone:} ${formData.tone}\\par
{\\b Length:} ${formData.length}\\par
{\\b Generated:} ${new Date().toLocaleDateString()}\\par
\\par
${editableScript.replace(/\n/g, '\\par ')}}`;

                    const blob = new Blob([rtfContent], { type: 'application/rtf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${formData.topic.replace(/[^a-zA-Z0-9]/g, '_')}_script.doc`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('DOC generation error:', error);
                    alert('❌ DOC generation failed. Please try copying the script instead.');
                }
            };

            // Simple markdown renderer for preview
            const renderMarkdown = (text) => {
                return text
                    .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold text-gray-800 mt-6 mb-3">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold text-gray-900 mb-4">$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="italic text-gray-700">$1</em>')
                    .replace(/^- (.*$)/gm, '<li class="ml-4 text-gray-700">• $1</li>')
                    .replace(/^(\d+)\. (.*$)/gm, '<li class="ml-4 text-gray-700">$1. $2</li>')
                    .replace(/^---$/gm, '<hr class="border-gray-300 my-4">')
                    .replace(/\n\n/g, '</p><p class="text-gray-700 mb-3">')
                    .replace(/^(.+)$/gm, '<p class="text-gray-700 mb-3">$1</p>')
                    .replace(/<p class="text-gray-700 mb-3"><h/g, '<h')
                    .replace(/<\/h([1-6])><\/p>/g, '</h$1>');
            };

            // Loading screen while Firebase initializes
            if (authLoading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div className="glass rounded-3xl p-8 text-center">
                            <div className="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <h2 className="text-xl font-semibold text-gray-800">Loading...</h2>
                            <p className="text-gray-600">Initializing AI Script Generator</p>
                        </div>
                    </div>
                );
            }

            // Authentication Screen
            if (!user) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                        <div className="glass rounded-3xl p-8 max-w-md w-full text-center slide-up">
                            <div className="mb-8">
                                <h1 className="text-4xl font-bold text-gray-800 mb-4">
                                    🎬 AI Script Generator
                                </h1>
                                <p className="text-gray-600 text-lg">
                                    Create engaging video scripts with AI assistance
                                </p>
                            </div>

                            {error && (
                                <div className="mb-6 p-4 bg-red-100 border border-red-300 rounded-xl text-red-700 text-sm">
                                    <div className="flex items-center space-x-2">
                                        <span>⚠️</span>
                                        <span>{error}</span>
                                    </div>
                                </div>
                            )}

                            <button
                                onClick={signInWithGoogle}
                                disabled={loading}
                                className="w-full bg-white border-2 border-gray-200 text-gray-700 px-6 py-4 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-300 flex items-center justify-center space-x-3 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <>
                                        <div className="animate-spin w-6 h-6 border-2 border-gray-400 border-t-transparent rounded-full"></div>
                                        <span>Signing in...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-6 h-6" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        <span>Continue with Google</span>
                                    </>
                                )}
                            </button>

                            {/* Hidden container for Google sign-in button rendering */}  
                            <div id="temp-google-signin" style={{display: 'none'}}></div>

                            <div className="mt-8 grid grid-cols-3 gap-4 text-center">
                                <div className="p-3">
                                    <div className="text-2xl mb-2">🤖</div>
                                    <div className="text-sm text-gray-600">AI-Powered</div>
                                </div>
                                <div className="p-3">
                                    <div className="text-2xl mb-2">⚡</div>
                                    <div className="text-sm text-gray-600">Fast Generation</div>
                                </div>
                                <div className="p-3">
                                    <div className="text-2xl mb-2">✨</div>
                                    <div className="text-sm text-gray-600">Customizable</div>
                                </div>
                            </div>

                            <div className="mt-6 text-xs text-gray-500">
                                <p>🔒 Secure authentication with Google</p>
                                <p>Your data is protected and never shared</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen gradient-bg p-4">
                    <div className="max-w-4xl mx-auto">
                        {/* Error Banner */}
                        {error && (
                            <div className="mb-6 p-4 bg-red-100 border border-red-300 rounded-xl text-red-700 flex items-center justify-between fade-in">
                                <div className="flex items-center space-x-2">
                                    <span>⚠️</span>
                                    <span>{error}</span>
                                </div>
                                <button 
                                    onClick={() => setError(null)}
                                    className="text-red-500 hover:text-red-700 text-xl"
                                >
                                    ×
                                </button>
                            </div>
                        )}

                        {/* Header */}
                        <div className="glass rounded-3xl p-6 mb-6 fade-in">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <img
                                        src={user.photoURL}
                                        alt={user.displayName}
                                        className="w-12 h-12 rounded-full"
                                    />
                                    <div>
                                        <h2 className="text-xl font-bold text-gray-800">
                                            Welcome, {user.displayName}!
                                        </h2>
                                        <p className="text-gray-600">{user.email}</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className={`px-4 py-2 rounded-xl text-white font-semibold ${levelInfo.color}`}>
                                        {levelInfo.level}
                                    </div>
                                    <button
                                        onClick={signOut}
                                        className="text-gray-600 hover:text-gray-800 transition-colors"
                                    >
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                            
                            {/* Progress Bar */}
                            <div className="mt-4">
                                <div className="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>Scripts Generated: {scriptCount}</span>
                                    <span>Progress to next level</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2">
                                    <div
                                        className="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${levelInfo.progress}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Form Section */}
                            <div className="glass rounded-3xl p-8 slide-up">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                    🎬 Generate Script
                                </h1>
                                <p className="text-gray-600 mb-8">
                                    Create engaging video scripts with AI assistance
                                </p>

                                <form onSubmit={handleSubmit} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            💡 Content Topic
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.topic}
                                            onChange={(e) => setFormData({...formData, topic: e.target.value})}
                                            placeholder="e.g., How to start a YouTube channel"
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            📧 Email Address
                                        </label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            placeholder="e.g., your.email@example.com"
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                👥 Target Audience
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.audience}
                                                onChange={(e) => setFormData({...formData, audience: e.target.value})}
                                                placeholder="e.g., Beginners"
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                🎨 Tone & Style
                                            </label>
                                            <select
                                                value={formData.tone}
                                                onChange={(e) => setFormData({...formData, tone: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                                required
                                            >
                                                <option value="">Select tone...</option>
                                                <option value="professional">Professional</option>
                                                <option value="casual">Casual & Friendly</option>
                                                <option value="humorous">Humorous</option>
                                                <option value="educational">Educational</option>
                                                <option value="inspirational">Inspirational</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            ⏱️ Script Length
                                        </label>
                                        <select
                                            value={formData.length}
                                            onChange={(e) => setFormData({...formData, length: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                        >
                                            <option value="short">Short (30-60 seconds)</option>
                                            <option value="medium">Medium (1-3 minutes)</option>
                                            <option value="long">Long (3-5 minutes)</option>
                                            <option value="extended">Extended (5+ minutes)</option>
                                        </select>
                                    </div>

                                    <button
                                        type="submit"
                                        disabled={loading || scriptGenerated}
                                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {loading ? (
                                            <div className="flex items-center justify-center space-x-2">
                                                <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                                                <span>Generating...</span>
                                            </div>
                                        ) : scriptGenerated ? (
                                            "✅ Script Generated"
                                        ) : (
                                            "✨ Generate My Script"
                                        )}
                                    </button>
                                </form>
                            </div>

                            {/* Script Preview Section */}
                            {scriptGenerated && (
                                <div className="glass rounded-3xl p-8 fade-in">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                                📝 Your Generated Script
                                            </h2>
                                            <p className="text-gray-600">
                                                Review and edit your script before sending it to your email.
                                            </p>
                                        </div>
                                        
                                        {/* View Mode Toggle */}
                                        <div className="flex bg-gray-100 rounded-lg p-1">
                                            <button
                                                onClick={() => setViewMode('edit')}
                                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                    viewMode === 'edit' 
                                                        ? 'bg-white text-gray-900 shadow-sm' 
                                                        : 'text-gray-600 hover:text-gray-900'
                                                }`}
                                            >
                                                ✏️ Edit
                                            </button>
                                            <button
                                                onClick={() => setViewMode('preview')}
                                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                    viewMode === 'preview' 
                                                        ? 'bg-white text-gray-900 shadow-sm' 
                                                        : 'text-gray-600 hover:text-gray-900'
                                                }`}
                                            >
                                                👁️ Preview
                                            </button>
                                        </div>
                                    </div>

                                    {/* Edit Mode */}
                                    {viewMode === 'edit' && (
                                        <textarea
                                            value={editableScript}
                                            onChange={(e) => setEditableScript(e.target.value)}
                                            className="w-full h-96 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all resize-none font-mono text-sm"
                                            placeholder="Your generated script will appear here..."
                                        />
                                    )}

                                    {/* Preview Mode */}
                                    {viewMode === 'preview' && (
                                        <div 
                                            className="w-full h-96 px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 overflow-y-auto prose prose-sm max-w-none"
                                            dangerouslySetInnerHTML={{ __html: renderMarkdown(editableScript) }}
                                        />
                                    )}

                                    <div className="mt-6 space-y-4">
                                        <button
                                            onClick={sendScript}
                                            disabled={loading || scriptSent}
                                            className="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-4 rounded-xl font-semibold hover:from-green-600 hover:to-blue-600 transition-all duration-300 disabled:opacity-50"
                                        >
                                            {loading ? (
                                                <div className="flex items-center justify-center space-x-2">
                                                    <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                                                    <span>Sending...</span>
                                                </div>
                                            ) : scriptSent ? (
                                                "📧 Script Sent to Email!"
                                            ) : (
                                                "📧 Send Script to Email"
                                            )}
                                        </button>

                                        {/* Download options */}
                                        <div className="grid grid-cols-3 gap-3">
                                            <button
                                                onClick={() => {
                                                    navigator.clipboard.writeText(editableScript);
                                                    alert('📋 Script copied to clipboard!');
                                                }}
                                                className="px-3 py-3 border-2 border-blue-300 text-blue-700 rounded-xl font-semibold hover:bg-blue-50 transition-all duration-300 flex items-center justify-center space-x-2 text-sm"
                                            >
                                                <span>📋</span>
                                                <span>Copy</span>
                                            </button>
                                            
                                            <button
                                                onClick={downloadAsPDF}
                                                className="px-3 py-3 border-2 border-red-300 text-red-700 rounded-xl font-semibold hover:bg-red-50 transition-all duration-300 flex items-center justify-center space-x-2 text-sm"
                                            >
                                                <span>📄</span>
                                                <span>PDF</span>
                                            </button>

                                            <button
                                                onClick={downloadAsDOC}
                                                className="px-3 py-3 border-2 border-purple-300 text-purple-700 rounded-xl font-semibold hover:bg-purple-50 transition-all duration-300 flex items-center justify-center space-x-2 text-sm"
                                            >
                                                <span>📝</span>
                                                <span>DOC</span>
                                            </button>
                                        </div>

                                        {/* Fallback Email Option */}
                                        <div className="mt-4">
                                            <button
                                                onClick={() => {
                                                    const subject = encodeURIComponent(`Your AI Generated Script: ${formData.topic}`);
                                                    const body = encodeURIComponent(`Here's your AI generated script:

Title: ${formData.topic}
Target Audience: ${formData.audience}
Tone: ${formData.tone}
Length: ${formData.length}
Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}

Script Content:
${editableScript}

---
Generated by AI Script Generator`);
                                                    
                                                    const mailtoLink = `mailto:${formData.email}?subject=${subject}&body=${body}`;
                                                    window.open(mailtoLink, '_blank');
                                                }}
                                                className="w-full border-2 border-green-300 text-green-700 px-6 py-3 rounded-xl font-semibold hover:bg-green-50 transition-all duration-300 flex items-center justify-center space-x-2"
                                            >
                                                <span>📬</span>
                                                <span>Open in Email App (Fallback)</span>
                                            </button>
                                        </div>

                                        <button
                                            onClick={() => {
                                                setScriptGenerated(false);
                                                setScriptSent(false);
                                                setShowFeedback(false);
                                            }}
                                            className="w-full border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-300"
                                        >
                                            🔄 Generate New Script
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Feedback Section */}
                        {showFeedback && (
                            <div className="glass rounded-3xl p-8 mt-6 fade-in">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    💬 How was your experience?
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    Your feedback helps us improve the AI script generation.
                                </p>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Rate the generated script:
                                        </label>
                                        <div className="flex space-x-4">
                                            <button
                                                onClick={() => setFeedback({...feedback, rating: 'positive'})}
                                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                                    feedback.rating === 'positive'
                                                        ? 'bg-green-500 text-white'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                👍 Good
                                            </button>
                                            <button
                                                onClick={() => setFeedback({...feedback, rating: 'negative'})}
                                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                                    feedback.rating === 'negative'
                                                        ? 'bg-red-500 text-white'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                👎 Needs Improvement
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Additional comments (optional):
                                        </label>
                                        <textarea
                                            value={feedback.comment}
                                            onChange={(e) => setFeedback({...feedback, comment: e.target.value})}
                                            placeholder="Tell us how we can improve..."
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all resize-none"
                                            rows="3"
                                        />
                                    </div>

                                    <button
                                        onClick={submitFeedback}
                                        disabled={feedback.rating === null}
                                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        🚀 Submit Feedback & Generate New Script
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the app using React 18 createRoot API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
